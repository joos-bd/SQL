# SQL
SQL

**Простые запросы. SELECT и FROM**

Для того чтобы получить данные, в запросе нужно указать:
- из какой таблицы хотим получить данные – предложение FROM;
- какие данные хотим вывести в результат – предложение SELECT.

Оператор * означает, что хотим вывести в результат все столбцы из таблицы customer, если нужно вывести определенные столбцы, то их нужно перечислить.

**Простые запросы. ALIAS** - Алиасы (псевдонимы) нужны для того, чтобы задавать временные названия для столбцов и таблиц. Алиасы для столбцов позволяют дать понятные названия для вычисляемых значений, а краткие алиасы для таблиц позволяют упростить написание запросов. Для задания алиасов используется оператор AS, но его можно опускать. Чтобы не писать полные названия таблиц, зададим в запросе на следующем слайде краткие алиасы и для вычисляемого столбца также зададим временное имя с обозначением результата.

**Простые запросы. ORDER BY** - В независимости от того, в каком порядке данные хранятся в базе данных, SQL возвращает результат в непредсказуемом порядке. Чтобы явно задать порядок сортировки, используется оператор ORDER BY. Для того чтобы задать направление сортировки, нужно указывать ASC – от меньшего к большему (по умолчанию) или DESC – от большего к меньшему. Давайте возьмем запрос с получением стоимости аренды фильма за день и отсортируем по стоимости аренды за день от большего к меньшему, а потом по названию фильма.

**Простые запросы. LIMIT и OFFSET**
- Если нужно получить первые N записей из результата, используется оператор LIMIT.
- Если нужно исключить из результата первые N записей, используется оператор OFFSET.


**Простые запросы. DISTINCT** - Для получения уникальных значений в результате, используется оператор DISTINCT.

**Простые запросы. WHERE** - Как правило, при получении данных нужно указать условия, по которым нужно их отфильтровать, для этого используется оператор WHERE. Если условий нужно использовать несколько, то используются логические операторы AND и OR. Для отрицания в условии используется оператор NOT.

**Простые запросы. CAST** - При работе с разными типами данных часто нужно преобразовывать один тип данных к другому, для этого используется оператор CAST

**Работа с числами**

**Округление** -  Для округления в MySQL используются следующие функции:
- ROUND – округляет число до заданного числа десятичных знаков
- TRUNCATE – усекает число до указанного числа десятичных знаков
- FLOOR – возвращает наибольшее целочисленное значение, которое меньше или равно числу
- CEIL – возвращает наименьшее целочисленное значение, которое больше или равно числу
- ABS – возвращает абсолютное (положительное) значение числа.

**Арифметические операторы** - SQL поддерживает все основные арифметические операторы:
- + – * / – стандартные операторы
- POWER – возведение в степень
- SQRT – возвращает квадратный корень числа
- COS, SIN, TAN, COT, etc – геометрические операторы
- DIV – целочисленное деление
- % – остаток от деления
- GREATEST/LEAST – возвращает наибольшее/наименьшее значение из списка,
- RAND – возвращает случайное число в диапазоне от 0 (включительно) до 1 (исключительно).

**Работа со строками** - Разберем основные функции для работы с подстроками и строками:
- CONCAT, CONCAT_WS – соединяет строки в одну, _WS – по сепаратору
- LENGTH – возвращает длину строки в байтах
- CHAR_LENGTH – возвращает длину строки в символах
- POSITION – возвращает позицию первого вхождения подстроки в строку
- SUBSTR – извлекает подстроку из строки
- LEFT / RIGHT – извлекает ряд символов из строки начиная слева / справа
- LOWER / UPPER – преобразует строку в нижний / верхний регистр
- INSERT – вставляет подстроку в строку в указанной позиции и для определенного количества символов
- TRIM – удаляет начальные и конечные пробелы из строки
- REPLACE – заменяет все вхождения подстроки в строке на новую подстроку
- SUBSTRING_INDEX – возвращает подстроку строки до того, как появится указанное число разделителей

Выражение LIKE возвращает true, если строка соответствует заданному шаблону. Выражение NOT LIKE возвращает false, когда LIKE возвращает true и наоборот. Если шаблон не содержит знаков процента и подчеркиваний, тогда шаблон представляет в точности строку и LIKE работает как оператор сравнения. Подчеркивание (_) в шаблоне подменяет (вместо него подходит) любой символ. Знак процента (%) подменяет любую (в том числе и пустую) последовательность символов

**Работа с датами и временем** - Разберем основные функции для работы с датами и временем:
- NOW / CURDATE – возвращает текущие дату и время / дату
- DATE_ADD – добавляет интервал времени/даты к дате, а затем возвращает дату, работает как с датой, так и со временем
- DATE_SUB – вычитает интервал времени/даты из даты, а затем возвращает дату, работает как с датой, так и со временем
- YEAR / MONTH / DAY — возвращает год / месяц / день месяца для заданной даты
- EXTRACT – извлекает часть из заданной даты
- DATEDIFF – возвращает количество дней между двумя значениями даты
- QUARTER – возвращает квартал года для заданного значения даты
- DATE_FORMAT – форматирует указанную дату
- TIME_FORMAT – форматирует время по заданному формату
- DATE – извлекает дату из выражения datetime

**BETWEEN** - Для того чтобы найти значения в заданном диапазоне, используется оператор BETWEEN. Данный оператор можно использовать с числами, строками и датами. Крайние значения включаются в результат

**JOIN** - В SQL JOIN’ы используются для соединения нескольких таблиц и получения из них данных. Существуют следующие типы JOIN:
- INNER JOIN
- LEFT JOIN
- RIGHT JOIN
- FULL JOIN
- CROSS JOIN

В LEFT OUTER JOIN, RIGHT OUTER JOIN и FULL OUTER JOIN ключевое слово OUTER можно опустить, оно не обязательно для использования. Также при использовании INNER JOIN можно опустить ключевое слово INNER. При работе с JOIN желательно использовать алиасы, для удобства чтения/написания запросов и указания, из каких таблиц какие столбцы нужно получать.

- INNER JOIN возвращает данные по строкам, содержащим одинаковые значения
- LEFT JOIN возвращает все данные из левой таблицы. Если по ним есть совпадения в правой, они обогащаются соответствующими данными, иначе туда записывается специальное значение NULL. Чтобы получить только те строки, которые не содержат данных в правой таблице, можно использовать оператор WHERE
- RIGHT JOIN — это обратная версия LEFT JOIN. Возвращает все данные из правой таблицы. Если по ним есть совпадения в левой, они обогащаются соответствующими данными, иначе туда записывается специальное значение NULL
- FULL JOIN не поддерживается MySQL. Рассмотрим его синтаксис в других СУБД и как реализовать в MySQL. FULL JOIN позволяет получить сопоставление по всем строкам в обеих таблицах. То есть получаем все данные из левой и правой таблиц, а там, где сопоставлений нет — добавляются значения NULL. Чтобы получить список уникальных строк из обеих таблиц, можно также воспользоваться оператором WHERE
- CROSS JOIN — это Декартово произведение, когда каждая строка левой таблицы сопоставляется с каждой строкой правой таблицы. В результате получается таблица со всеми возможными сочетаниями строк обеих таблиц

UNION / EXCEPT -  Если при работе с JOIN соединение данных происходит «слева» или «справа», то при работе с операторами UNION или EXCEPT работа происходит «сверху» и «снизу»
- При объединении данных через оператор UNION в результате будет список уникальных значений для двух таблиц
- При объединении данных через оператор UNION ALL в результате будет список всех значений для двух таблиц
- При использовании оператора EXCEPT из значений, полученных в верхней части запроса, будут вычтены значения, которые совпадут со значениями, полученными в нижней части запроса

**Агрегатные функции**

**Агрегация** — когда данные группируются по ключу, в качестве которого выступает один или несколько атрибутов, и внутри каждой группы вычисляются некоторые статистики.
- SUM — возвращает общую сумму числового столбца
- COUNT — возвращает количество строк, соответствующих заданному критерию
- AVG — возвращает среднее значение числового столбца
- MIN — возвращает наименьшее значение выбранного столбца
- MAX — возвращает наибольшее значение выбранного столбца

**Группировка данных**

GROUP BY — агрегирующий оператор, с помощью которого можно формировать данные по группам и уже в рамках этих групп получать значения с помощью агрегатных функций. Группировать можно как по одному атрибуту, так и по нескольким. При этом важно помнить, что все значения указанные в SELECT, которые не указаны внутри агрегатных функций, должны быть указаны в операторе GROUP BY.

Если при использовании агрегации и группировки данных нужно вывести несколько столбцов из одной таблицы, то вместо указания всех этих столбцов в GROUP BY можно использовать Функциональную Зависимость.

**HAVING** - Вспоминая логический порядок инструкции SELECT: оператор WHERE фильтрует данные до группировки, а чтобы отфильтровать сгруппированные данные, используется оператор HAVING

**Подзапросы**

**Подзапрос** — это SELECT, результаты которого используются в другом SELECT. Подзапросы нужны для разделения логики в основном запросе.

Подзапросы могут использоваться в любой части запроса, в зависимости от этой части запроса подзапросы могут возвращать:
- отдельное значение,
- таблицу,
- одномерный массив.
Если подзапрос возвращает таблицу, подзапросу обязательно задается алиас

**CASE** - Выражение CASE в SQL представляет собой общее условное выражение, напоминающее операторы if/else в других языках программирования. Типы данных всех выражений результатов должны приводиться к одному выходному типу.

**IFNULL** - Функция IFNULL позволяет возвращать альтернативное значение, если выражение возвращает NULL.

**COALESCE** - Функция COALESCE позволяет возвращать первое значение из списка, которое не равно NULL
